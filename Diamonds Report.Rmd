---
title: "Diamonds Analysis and Prediction"
author: "Shaun Cass"
date: "3/20/2021"
output: pdf_document
---


```{r load packages and data, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(patchwork)
library(GGally)
library(magick)

load("Data/updated_diamonds.Rda")
load("Data/ridge_fit1_rs.Rda")
load("Data/ridge_fit2_rs.Rda")
load("Data/ridge_fit3_rs.Rda")
load("Data/glmnet_fit1_rs.Rda")
load("Data/glmnet_fit2_rs.Rda")
load("Data/glmnet_fit3_rs.Rda")
load("Data/tree_fit_tune.Rda")
load("Data/rf_fit_tune.Rda")
load("Data/rf_fit_tune_fine.Rda")
load("Data/y11_idsdiamonds.Rda")
load("Data/zhigh_idsdiamonds.Rda")
load("Data/rec_calc_total_depth.Rda")
load("Data/largediff_depth.Rda")
load("Data/data_split.Rda")
load("Data/train_data.Rda")
load("Data/test_data.Rda")
```

# Introduction

Round cut diamonds (also called round brilliant) are the most popular shape of diamond and are often used in jewelery such as engagement rings. The 

# Methods

## About the Data

The Diamonds data set was originally procured by requesting the data set from Dr. Crawford at Texas A&M. Upon further inspection, it was realized that this data set was a common data set used for learning how to make exploratory graphics and perform rudimentary inference. This data set comes standard in the ggplot2 package and includes a desciption of the data that we have reproduced in table 1. 

The Diamonds data set contains the the characteristics of 53,940 round cut diamonds. The variables associated with each diamond are as follows: price (in US Dollars), carat (weight), Cut (Fair, Good, Very Good, Premium, Ideal), Color (D (best) to J (worst)), Clarity (I1 (worst), SI2, SI1, VS2, VS1, VVS2, VVS1, IF (best), x (length in mm), y (width in mm), z (depth in mm), depth (total depth percentage), and table (total table percentage). Cut, color, and clarity were ordered categorical variables as described in table 1 while the rest were numerical variables. Based on the data description and the use of the Diamonds data set in other reports, the data was believed to contain independent observations and the methods used in this report treated each observation as independent of one another. 

```{r Diamonds description table, echo=FALSE}
ddf <- data.frame("Variable" = c("price", "carat", "cut", "color", "clarity", "x", "y", "z", "depth", "table"),
                  "Description" = c("Price in US dollars ($326–$18,823)",
                                    "Weight of the diamond (0.2–5.01)",
                                    "Quality of the cut (Fair, Good, Very Good, Premium, Ideal)",
                                    "Diamond colour, from D (best) to J (worst)",
                                    "A measurement of how clear the diamond is (I1 (worst), SI2, SI1, VS2, VS1, VVS2, VVS1, IF (best))",
                                    "Length in mm (0–10.74)",
                                    "Width in mm (0–58.9)",
                                    "Depth in mm (0–31.8)",
                                    "Total depth percentage = z / mean(x, y) = 2 * z / (x + y) (43–79)",
                                    "Width of top of diamond relative to widest point (43–95)"))

ddf %>%
  kable(format = "latex", align = "c",
        caption = "Description of the Diamonds data set from the ggplot2 package.")
```


The diamonds in the data set were graded using the Gemmological Institute of America's (GIA) grading system. The four primary the GIA uses to characterize a faceted diamond are color, clarity, cut, and carat weight. The GIA has instituted objective measures to grade these properties of faceted diamonds and diamonds can be graded at one of the nine GIA grading laboratories. 

```{r GIA color image, echo=FALSE, out.extra='trim={0 4.5cm 0 4cm},clip', fig.cap="GIA color scale."}
GIAcolor <- image_read("Figures/GIA_color_scale.jpg")
plot(GIAcolor)

```

The GIA scale for the color of a diamond ranges from the top grade "D" (colorless) to the worst grade "Z" (light yellow) (Figure 1). The diamonds in the data set used only ranged from "D" to "J" meaning that the predictive model built on this data would not be useful for "Faint", "Very Light", or "Light" colored diamonds. 

```{r GIA clarity image, echo=FALSE, out.extra='trim={0 4.5cm 0 4cm},clip', fig.cap="GIA clarity scale."}
GIAclarity <- image_read("Figures/GIA_clarity_scale.jpg")
plot(GIAclarity)

```

The clarity scale that the GIA grades a faceted diamond ranges from Flawless to I3 (figure 2). Inclusions are imperfections usually caused by the heat and pressure that become apparent with the use of a microscope. An example would be a mineral crystal within the diamond itself or even a break in the gemstone. The Diamonds data set only contained diamonds with a clarity that ranged from Internally Flawless (IF) to the first level of Included (I1) so the predictive model built on this data set would not be useful for diamonds whose clarity is Flawless, I2, or I3.

```{r GIA cut image, echo=FALSE, out.extra='trim={0 5cm 0 4cm},clip', fig.cap="GIA cut scale."}
GIAcut <- image_read("Figures/GIA_cut_scale.jpg")
plot(GIAcut)

```

The GIA scale for the cut of a diamond

```{r GIA diamond anatomy image, echo=FALSE, out.extra='trim={0 3.2cm 0 3.5cm},clip', fig.cap="GIA anatomy of a diamond."}
GIAanatomy <- image_read("Figures/GIA_anatomy_of_diamond.jpg")
plot(GIAanatomy)

```

The statistical programming language R was used within Rstudio along with the following packages: tidyverse, GGally, tidymodels, doParallel, parallel, and vip. 























## Missing values and Outliers

The data initially had no missing values, but upon further inspection it was found that there were 20 rows where either the x, y, or z measurement had a value of zero. These zero values were replaced with missing values (NA in R) as it would not be possible for a round cut diamond to have zero length, width, or depth. 12 of these rows only contained one variable with a missing value: the z variable. Because total depth percentage, x, and y were not missing and the total depth percentage by definition was a calculation using x, y, and z, we thought it was appropriate to replace these 12 missing z values using the following formula derived from the total depth percentage calculation:
$$z=\frac{depth\%*(x+y)}{2*100}$$

The calculated z value was rounded to the second decimal place to match the format of the other z values in the data set. 

Additionally, two observations were found where y (width in mm) was abnormally larger than x (length in mm). Since round cut diamonds are cut diamonds where x and y are supposed to be relatively close to each other, it is highly unlikely that y would be six to seven times greater than x as seen in table 2. Also, the depth (z) of the diamond tends to be smaller than the average of x and y and round cut diamonds having greater than 100% depth percentage seems extremely unlikely as a round cut diamond is considered poor once its depth percentage is greater than 70.9% (Figure 1).

![GIA total depth percentage grading for round cut diamonds](Figures/gia_totaldepth_table.PNG)

```{r abnormally large ys, echo=FALSE}
y11_idsdiamonds %>%
  kable(format = "latex", align = "c",
        caption = "Abnormally large values of y in the Diamonds data set.")
```

Likewise, using GIA's $Facetware^{(R)}$ which compares proportions of round cut diamonds to 38.5 million proportion sets, the highest total depth percentage we were able to acheive using a given set of parameters was 83.8%. Examining table 2 further, we also saw that the z value was extremely close in value to x. Based on this information it was decided that the z values in table 2 were actually supposed to be the y values. These two observations were corrected by replacing the y values with the given z values and calculating new z values using the same formula as before.

Two other observations were found where the depth (z) was greater than the average of x and y (table 3). These observations were also corrected so using the same z formula as before.
```{r zhigh diamonds, echo=FALSE}
zhigh_idsdiamonds %>%
  kable(format = "latex", align = "c",
        caption = "Diamonds where depth (z) is greater than the average diameter.")
```

To find additional discrepancies in the data, the total depth percentage was calculated for all other observations using the formula in table 1. There were obvious differences between the calculated and recorded total depth percentages as seen in figure 2. It was found that there were 120 observations with a 1% difference or more between the recorded and calculated total depth percentage. Going further, there were 18 observations with a 10% difference or more between the recorded and calculated total depth percentage. The x and y features of these 18 observations noticeably similar with x ranging from 0.75 t0 1.62 times the size of y. The z values were again suspected to be the reason for the noticeable difference between the recorded and calculated total depth percentages for these 18 observations. The z values were thus replaced using the same formula as before. To avoid possibly biasing the data, any remaining observations that had a difference between the recorded and calculated total depth percentage were left as is. 

# Need to redo calc vs. recorded total depth percentage graph, can't save ggplot2 graphics


```{r recorded vs calculated depth, echo=FALSE}
rec_calc_total_depth %>%
  drop_na() %>%
  ggally_points(aes(x = temp_depth, y = depth)) +
  geom_abline(aes(slope = 1, intercept = 0, color = "red"), linetype = "dashed") +
  xlab("Calculated Total Depth Percentage") +
  ylab("Recorded Total Depth Percentage") +
  ggtitle("Recorded vs. Calculated Total Depth Percentage") +
  scale_color_manual(name = "Ratio", values = c("red" = "red"), labels = "1:1") +
  scale_x_continuous(labels = scales::label_percent(accuracy = 1, scale = 1)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1, scale = 1))+
  theme_bw() 
```


The response variable for the Diamonds data set was decided to be the price in US dollars for each diamond. 
```{r price and log price, echo=FALSE}
a <- diamonds %>%
  ggplot(aes(x = price)) +
  geom_density(size = 1.05, fill = "steelblue", alpha = 0.8) +
  ggtitle("Distribution of the Diamonds' Price") +
  xlab("Price (US Dollars)") +
  ylab("Density") +
  geom_vline(aes(xintercept = mean(price), color = "Mean"), linetype = "dashed") +
  geom_vline(aes(xintercept = quantile(price, 0.5), color = "Median"), linetype = "twodash") +
  scale_x_continuous(labels = scales::label_dollar()) +
  scale_color_manual(name = "", values = c(Mean = "deeppink1", Median = "darkorchid1")) +
  theme_minimal()

b <- diamonds %>%
  ggplot(aes(x = log(price)))  +
  geom_density(size = 1.05, fill = "steelblue", alpha = 0.8) +
  ggtitle("Distribution of the Diamonds' Price", subtitle = "Price is natural log transformed") +
  xlab("Price (log US Dollars)") +
  ylab("Density") +
  geom_vline(aes(xintercept = mean(log(price)), color = "Mean"), linetype = "dashed") +
  geom_vline(aes(xintercept = quantile(log(price), 0.5), color = "Median"), linetype = "twodash") +
  scale_x_continuous(labels = scales::label_dollar()) +
  scale_color_manual(name = "", values = c(Mean = "deeppink1", Median = "darkorchid1")) +
  theme_minimal()

c <- a / b & theme(legend.position = "right")
c + plot_layout(guides = "collect") +
  plot_annotation(caption = "Figure 3: Distribution of price and its natural log transformation.",
                  theme = theme(plot.caption = element_text(hjust = 0.5)))
```

Price had a heavily right-skewed distribution as noted in figure 3 with a sample mean of \$3932.8 and a sample median of \$2401. Price was natural log transformed so that no diamonds would be predicted to have a negative value of price and any errors in predicting the more expensive diamonds would not have a disporportionate influence on the model.

The other numerical features of the diamonds were also examined as seen in figure 4 and figure 5.
```{r dist of carat table and depth, echo=FALSE}
d <- diamonds %>%
  ggplot(aes(x = carat)) +
  geom_density(size = 1.05, fill = "red3", alpha = 0.8) +
  xlab("Weight (Carat)") +
  ylab("Density") +
  ggtitle("Distribution of the Diamonds' Weight (Carat)") +
  theme_minimal()

e <- diamonds %>%
  ggplot(aes(x = depth)) +
  geom_density(size = 1.05, fill = "violet", alpha = 0.8) +
  ggtitle("Distribution of the Diamonds' Total Depth Percentage") +
  xlab("Total Depth (%)") +
  ylab("Density") +
  scale_x_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal()

f <- diamonds %>%
  ggplot(aes(x = table))   +
  geom_density(size = 1.05, fill = "green4", alpha = 0.8) +
  ggtitle("Distribution of the Diamonds' Table Percentage") +
  xlab("Table (%)") +
  ylab("Density") +
  scale_x_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal()

d / e / f + plot_annotation(caption = "Figure 4: Distribution of carat, total depth percentage, and table percentage.",
                  theme = theme(plot.caption = element_text(hjust = 0.5)))
```

Like price, carat appeared to be right-skewed while the total depth percentage and table percentage were fairly symmetrical. On the other hand, the distributions of x and y were similar which was to be expected for round cut diamonds. The distribution of z was also noticeably centered on smaller values than x or y.

```{r dist of x y and z, echo=FALSE}
g <- diamonds %>%
  select(x, y, z) %>%
  drop_na() %>%
  ggplot(aes(x = x)) +
  geom_density(fill = "turquoise3", alpha = 0.8, size = 1.05) +
  ggtitle("Distribution of the Diamonds' Length") +
  xlab("x (mm)") +
  ylab("Density") +
  scale_x_continuous(limits = c(0, 11)) +
  theme_minimal()

h <- diamonds %>%
  select(x, y, z) %>%
  drop_na() %>%
  ggplot(aes(x = y)) +
  geom_density(fill = "deeppink3", alpha = 0.8, size = 1.05) +
  ggtitle("Distribution of the Diamonds' Width") +
  xlab("y (mm)") +
  ylab("Density") +
  scale_x_continuous(limits = c(0, 11)) +
  theme_minimal()

i <- diamonds %>%
  select(x, y, z) %>%
  drop_na() %>%
  ggplot(aes(x = z)) +
  geom_density(fill = "palegreen3", alpha = 0.8, size = 1.05) +
  ggtitle("Distribution of the Diamonds' Depth") +
  xlab("z (mm)") +
  ylab("Density") +
  scale_x_continuous(limits = c(0, 11)) +
  theme_minimal()  

g / h / i + plot_annotation(caption = "Figure 4: Distribution of x, y, and z (excluding eight observations with missing values).",
                  theme = theme(plot.caption = element_text(hjust = 0.5)))
```

The proportion of diamonds for each level of cut, clarity and color was also examined (figure 5). The worst levels of cut (Fair), clarity (I1), and color (J) made up a significantly smaller proportion of the data set compared to the other levels. Furthermore, the best level of clarity (IF) was only present in 3.32% of the data. These proportions indicated that predictions on diamonds having these levels may not be as robust due to the relatively small amount of data used to train a model.





```{r dist of cut clarity and color, echo=FALSE}
cut <- diamonds %>%
  ggplot(aes(x = cut)) +
  geom_bar(aes(y = ..prop.., group = 1)) +
  xlab("Cut") +
  ylab("Proportion") +
  ggtitle("Proportion of Diamonds Per Cut Type", subtitle = "Sorted from worst (Fair) to best (Ideal)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 7),
        title = element_text(size = 8))

clarity <- diamonds %>%
  ggplot(aes(x = clarity)) +
  geom_bar(aes(y = ..prop.., group = 1)) +
  xlab("Clarity") +
  ylab("Proportion") +
  ggtitle("Proportion of Diamonds Per Clarity Type", subtitle = "Sorted from worst (I1) to best (IF)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 7),
        title = element_text(size = 8))

color <- diamonds %>%
  ggplot(aes(x = color)) +
  geom_bar(aes(y = ..prop.., group = 1)) +
  xlab("Color") +
  ylab("Proportion") +
  ggtitle("Proportion of Diamonds Per Color Type", subtitle = "Sorted from worst (J) to best (D)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 7),
        title = element_text(size = 8)) 

cut + clarity + color + plot_annotation(caption = "Figure 5: Distribution of cut, clarity, and color.",
                  theme = theme(plot.caption = element_text(hjust = 0.5))) +
  plot_layout(nrow = 2)

```

This was was further explored by examining the bivariate proportions for cut, color, and clarity (figure 6). If any two-way interactions existed between these categorical features, then the sparse amount of diamonds for certain combinations of these features may impact the accuracy of a model for future predictions on similar diamonds. For instance, there were only nine diamonds in total with a cut equal to "Fair" and a clarity equal to "IF". Predictions for diamonds similar to these may not be as accurate as the other combinations.


```{r categorical heatmaps, echo=FALSE, message=FALSE}
color_cut <- diamonds %>%
  group_by(cut, color) %>%
  summarise(n_part = n()) %>%
  group_by(cut) %>%
  mutate(Density = n_part/53940) %>%
  ggplot(aes(x = cut, y = color, fill = Density)) +
  geom_tile()  +
  scale_fill_viridis_c(name = "Proportion of \nTotal Data") +
  theme_minimal() +
  xlab("Cut") +
  ylab("Color") +
  ggtitle("Proportion of Total Data for Each Color and Cut") +
  scale_size(name = "Proportion of \nTotal Data") +
  theme(axis.text.x = element_text(size = 5.2),
        title = element_text(size = 7))

clarity_cut <- diamonds %>%
  group_by(cut, clarity) %>%
  summarise(n_part = n()) %>%
  group_by(cut) %>%
  mutate(Density = n_part/53940) %>%
  ggplot(aes(x = cut, y = clarity, fill = Density)) +
  geom_tile()  +
  scale_fill_viridis_c(name = "Proportion of \nTotal Data") +
  theme_minimal() +
  xlab("Cut") +
  ylab("Clarity") +
  ggtitle("Proportion of Total Data for Each Clarity and Cut") +
  scale_size(name = "Proportion of \nTotal Data") +
  theme(axis.text.x = element_text(size = 5.2),
        title = element_text(size = 7))

clarity_color <- diamonds %>%
  group_by(color, clarity) %>%
  summarise(n_part = n()) %>%
  group_by(color) %>%
  mutate(Density = n_part/53940) %>%
  ggplot(aes(x = color, y = clarity, fill = Density)) +
  geom_tile()  +
  scale_fill_viridis_c(name = "Proportion of \nTotal Data") +
  theme_minimal() +
  xlab("Color") +
  ylab("Clarity") +
  ggtitle("Proportion of Total Data for Each Clarity and Color") +
  scale_size(name = "Proportion of \nTotal Data") +
  theme(title = element_text(size = 7))

color_cut + clarity_cut  / clarity_color +
  plot_annotation(caption = "Figure 6: Bivariate proportions for cut, color, and clarity.",
                  theme = theme(plot.caption = element_text(hjust = 0.5)))
```

When the distribution of the natural log of price was compared across the levels of cut, clarity, and color (figure 7), it became obvious that many of the levels that made up a smaller proportion of the data had a much tighter distribution than the other levels. Some such as the I1 and IF level of clarity also had a fair amount of outliers. This may be due to how the data was sampled and may not be representative of how these types of diamonds are priced. It was determined that depending on importance of these categorical variables, more diamonds with these rarer features may be needed in the future to increase the predictive accuracy of the model created.

```{r log price vs factor vars, echo=FALSE}
price_cut <- diamonds %>%
  ggplot(aes(x = cut, y = log(price))) +
  geom_boxplot() +
  xlab("Cut") +
  ylab("Price (log US Dollars)") +
  ggtitle("Distribution of log Price for each\nCut of Diamond") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 7),
        title = element_text(size = 7)) +
  scale_y_continuous(labels = scales::label_dollar())

price_color <- diamonds %>%
  ggplot(aes(x = color, y = log(price))) +
  geom_boxplot() +
  xlab("Color") +
  ylab("Price (log US Dollars)") +
  ggtitle("Distribution of log Price for each\nColor of Diamond") +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        title = element_text(size = 7)) +
  scale_y_continuous(labels = scales::label_dollar())

price_clarity <- diamonds %>%
  ggplot(aes(x = clarity, y = log(price))) +
  geom_boxplot() +
  xlab("Clarity") +
  ylab("Price (log US Dollars)") +
  ggtitle("Distribution of log Price for each\nClarity of Diamond") +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 7),
        title = element_text(size = 7)) +
  scale_y_continuous(labels = scales::label_dollar())

price_cut + price_color + price_clarity +
  plot_annotation(caption = "Figure 7: Distribution of log price for levels of cut, color, and clarity.",
                  theme = theme(plot.caption = element_text(hjust = 0.5)))

```


## Splitting the data



```{r corrplot of train data, echo=FALSE}
train_data %>%
  select(price, carat, depth, table, x, y, z) %>%
  drop_na() %>%
  ggcorr(label = TRUE) +
  ggtitle("Pearson Correlation of Continuous Variables in Training Data")
```




## Preliminary models and tuning

## Final model

# Results

# Conclusion